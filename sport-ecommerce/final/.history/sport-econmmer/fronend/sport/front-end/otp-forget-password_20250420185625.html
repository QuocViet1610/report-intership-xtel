<!DOCTYPE html>
<html lang="en">



<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/images/logo/logoHeader1.png?v=1" type="image/png">
    <title>GOFIT</title>


    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.gstatic.com/">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&amp;display=swap">

    <!-- bootstrap css -->
    <link id="rtl-link" rel="stylesheet" type="text/css" href="../assets/css/vendors/bootstrap.css">

    <!-- Iconly css -->
    <link rel="stylesheet" type="text/css" href="../assets/css/bulk-style.css">

    <!-- Template css -->
    <link id="color-link" rel="stylesheet" type="text/css" href="../assets/css/style.css">
    <style>
        .form-control {
            border: 1px solid #ccc !important; /* Viền màu xám nhạt */
            border-radius: 5px; /* Bo tròn góc */
               }
            .log-in-button li{
                border: 1px solid #ccc !important; /* Viền màu xám nhạt */
                border-radius: 5px; /* Bo tròn góc */
            }
            .log-in-box{
                background: white !important; 
            }
    
            #countdown {
                font-size: 16px;
                color: var(--theme-color);
            }
    </style>
</head>

<body>

    <!-- Loader Start -->
    <div class="fullpage-loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>
    <!-- Loader End -->



    <!-- mobile fix menu start -->
    <!-- mobile fix menu end -->


    <!-- Breadcrumb Section End -->

    <!-- log in section start -->
    <section class="log-in-section otp-section section-b-space" style="width: 100vw; height: 100vh; padding: 0px;">
        <div class="container-fluid h-100">
            <div class="row h-100">
                <!-- Cột trái: ảnh -->
                <div class="col-lg-8 col-md-8 p-0 d-md-block d-none">
                    <div class="image-contain h-100 w-100">
                        <img src="https://thethemedemo.com/fitzoon/wp-content/uploads/revslider/home-1/4s-1.jpg"
                             class="img-fluid"
                             style="width: 100%; height: 100%; object-fit: cover;" 
                             alt="OTP background">
                    </div>
                </div>
    
                <!-- Cột phải: form OTP -->
                <div class="col-lg-4 col-md-4 d-flex align-items-center justify-content-center">
                    <div class="log-in-box">
                        <div class="log-in-title mb-4 text-center ">
                            <img src="../assets/images/logo/logo3.png" alt="GOFIT Logo" class="logo" style="width: 170px; height: 80px;">
                            <h3 class="text-title">Xác nhận tài khoản của bạn</h3>
                            <h5 class="text-content">Mã OTP đã được gửi đến địa chỉ <span class="maskedEmail ">*******32@gmail.com</span></h5>
                        </div>
    
                        <div id="otp" class="inputs d-flex flex-row justify-content-center gap-2 mb-3">
                            <input class="text-center form-control rounded" type="text" id="first" maxlength="1" placeholder="0">
                            <input class="text-center form-control rounded" type="text" id="second" maxlength="1" placeholder="0">
                            <input class="text-center form-control rounded" type="text" id="third" maxlength="1" placeholder="0">
                            <input class="text-center form-control rounded" type="text" id="fourth" maxlength="1" placeholder="0">
                            <input class="text-center form-control rounded" type="text" id="fifth" maxlength="1" placeholder="0">
                            <input class="text-center form-control rounded" type="text" id="sixth" maxlength="1" placeholder="0">
                        </div>
    
                        <div class="send-box pt-3 mb-3">
                            <h6>Bạn đã nhận được mã? <a href="javascript:void(0)" class="theme-color fw-bold" id="resend-otp">Gửi lại</a></h6>
                            <p id="countdown" style="display:none;"></p>
                        </div>
    
                        <button class="btn btn-animation w-100 btn-confirm" type="submit">
                            Xác nhận
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
      
    <!-- log in section end -->



    <!-- Tap to top and theme setting button end -->

    <!-- Bg overlay Start -->
    <div class="bg-overlay"></div>
    <!-- Bg overlay End -->

    <!-- latest jquery-->
    <script src="../assets/js/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap js-->
    <script src="../assets/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/bootstrap/popper.min.js"></script>

    <!-- otp js-->
    <script src="../assets/js/otp.js"></script>

    <!-- Slick js-->
    <script src="../assets/js/slick/slick.js"></script>
    <script src="../assets/js/slick/slick-animation.min.js"></script>
    <script src="../assets/js/slick/custom_slick.js"></script>

    <!-- feather icon js-->
    <script src="../assets/js/feather/feather.min.js"></script>
    <script src="../assets/js/feather/feather-icon.js"></script>

    <!-- Lazyload Js -->
    <script src="../assets/js/lazysizes.min.js"></script>

    <!-- script js -->
    <script src="../assets/js/script.js"></script>
</body>

<script>
    $(document).ready(function() {
 
        $("#first, #second, #third, #fourth, #fifth, #sixth").on("input", function() {
            // Nếu ô hiện tại có giá trị, chuyển focus sang ô tiếp theo
            if (this.value.length === 1) {
                var nextInput = $(this).next("input");
                if (nextInput.length) {
                    nextInput.focus(); // Chuyển tới ô tiếp theo
                }
            }
        });
    
        // Xử lý khi người dùng nhấn nút backspace và di chuyển về ô trước đó
        $("#first, #second, #third, #fourth, #fifth, #sixth").on("keydown", function(e) {
            // Nếu người dùng nhấn Backspace và ô hiện tại trống (là số cuối cùng)
            if (e.key === "Backspace" && this.value === "") {
                var prevInput = $(this).prev("input");
                if (prevInput.length) {
                    prevInput.focus(); // Chuyển về ô trước đó khi nhấn Backspace
                }
            }
        });
    
        // Xử lý khi người dùng xóa số cuối cùng mà không làm mất dữ liệu của các ô khác
        $("#sixth").on("keydown", function(e) {
            if (e.key === "Backspace" && this.value === "") {
                // Khi người dùng nhấn Backspace ở ô cuối, chỉ xóa 1 số cuối cùng
                e.preventDefault(); // Ngăn không cho xóa nhiều ký tự
            }
        });


        var savedCountdown = localStorage.getItem('otpCountdown');
        if (savedCountdown) {
            var countdown = parseInt(savedCountdown);
            var countdownDisplay = $("#countdown");
            countdownDisplay.show().text("Bạn có thể gửi lại sau " + countdown + " giây.");
    
            var interval = setInterval(function() {
                countdown--;
                countdownDisplay.text("Bạn có thể gửi lại sau " + countdown + " giây.");
    
                localStorage.setItem('otpCountdown', countdown);
    
                if (countdown <= 0) {
                    clearInterval(interval);
                    countdownDisplay.hide();
                    $("#resend-otp").show();
                    localStorage.removeItem('otpCountdown'); 
                    $("#resend-otp").text("Gửi lại"); 
                }
            }, 1000);
            $("#resend-otp").hide(); 
        }
    

        //gui lai ma
        $("#resend-otp").click(function() {
            
            sendOtpRequestPassword();
            // Thay đổi nội dung khi bấm nút "Gửi lại"
            $("h6").html("Mã đã được gửi lại");
    
            // Thực hiện đếm ngược lại
            var countdown = 60; 
            var countdownDisplay = $("#countdown");
            countdownDisplay.show().text("Bạn có thể gửi lại sau " + countdown + " giây.");
    
            // Lưu countdown vào localStorage khi bắt đầu
            localStorage.setItem('otpCountdown', countdown);
    
            var interval = setInterval(function() {
                countdown--;
                countdownDisplay.text("Bạn có thể gửi lại sau " + countdown + " giây.");
    
                // Lưu lại countdown vào localStorage sau mỗi giây
                localStorage.setItem('otpCountdown', countdown);
    
                if (countdown <= 0) {
                    clearInterval(interval); 
                    countdownDisplay.hide(); 
                    $("#resend-otp").show(); 
                    localStorage.removeItem('otpCountdown'); 
                    $("#resend-otp").text("Gửi lại"); 
                }
            }, 1000); 
            $(this).hide(); // Ẩn nút "Gửi lại" khi bấm
        });
        

// kiểm tra thông tin để gửi
        var otpSend = localStorage.getItem("otpSentForgetPassword"); 
        console.log(otpSend)
        if (otpSend === "true") {
            sendOtpRequestPassword();
            localStorage.setItem("otpSentForgetPassword", "false"); 
        }


        var forgetpasswordEmail = localStorage.getItem("forgetpasswordEmail");
    
        // Kiểm tra nếu có dữ liệu trong localStorage
        if (forgetpasswordEmail) {
            forgetpasswordEmail = JSON.parse(forgetpasswordEmail);
    
            $("#email").val(forgetpasswordEmail.email);
            var email = forgetpasswordEmail.email;
            var maskedEmail = email.substring(0, 3) + "****" + email.substring(email.indexOf("@") - 2);

        }
        var registerData = localStorage.getItem("registerRequest");
            
// comfirm ##########################################
$(".btn-confirm").click(function() {
    // Lấy các giá trị OTP từ các ô nhập liệu
    var otp = "";
    otp += $("#first").val();
    otp += $("#second").val();
    otp += $("#third").val();
    otp += $("#fourth").val();
    otp += $("#fifth").val();
    otp += $("#sixth").val();

    // Kiểm tra xem OTP có đầy đủ chưa
    if (otp.length === 6) {
        var forgetpasswordEmail = localStorage.getItem("forgetpasswordEmail");
        forgetpasswordEmail = JSON.parse(forgetpasswordEmail);
        $("#email").val(forgetpasswordEmail.email);
        var email = forgetpasswordEmail.email;


        var encodedEmail = encodeURIComponent(email);
        var encodedOtp = encodeURIComponent(otp);
        
        $.ajax({
            url: `http://localhost:8080/auth/verify-forget-password/${encodedEmail}/${encodedOtp}`,  // Gửi email và otp qua URL
            type: "POST",
            contentType: "application/json",  // Không cần phải gửi JSON trong body vì giá trị đã có trong URL
            success: function(response) {
                if (response.code === "200") { 
                    if (response.data) {
                        localStorage.removeItem('otpCountdown');
                        localStorage.removeItem("forgetpasswordEmail");
                        localStorage.removeItem("otpSentForgetPassword"); 
                        localStorage.setItem("authToken", token);
                        window.location.href = "change-password.html";  
                    }
                } else {
                    showError(response.message || "Mã OTP không đúng! Vui lòng kiểm tra lại.");
                }
            },
            error: function(xhr) {
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    showError(xhr.responseJSON.message);  // Hiển thị thông báo lỗi nếu có
                } else {
                    showError("Có lỗi xảy ra, vui lòng thử lại.");
                }
            }
        });
    } else {
        showError("Vui lòng nhập đầy đủ mã OTP.");
    }



});

    });

    function sendOtpRequestPassword() {
      
        var forgetpasswordEmail = localStorage.getItem("forgetpasswordEmail");
    
        // Kiểm tra nếu có dữ liệu trong localStorage
        if (forgetpasswordEmail) {
            forgetpasswordEmail = JSON.parse(forgetpasswordEmail);
    
            $("#email").val(forgetpasswordEmail.email);

            var email = forgetpasswordEmail.email;
            var maskedEmail = email.substring(0, 3) + "****" + email.substring(email.indexOf("@") - 2);
            $(".maskedEmail ").text(maskedEmail);

            var encodedEmail = encodeURIComponent(email);
            // Gửi yêu cầu OTP
            $.ajax({
                url: `http://localhost:8080/auth/send-otp-forget-password/${encodedEmail}`,
                type: "POST",
                success: function(response) {
                    console.log("Success response:", response);
                    if (response.code === "200") {
                        if (response.data) {
                            console.log(esponse.data)
                        }
                    } else {
                        showError(response.message || "Gửi mã OTP thất bại!");
                    }
                },
                error: function(xhr) {
                    console.log("Error response:", xhr);
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        showError(xhr.responseJSON.message);
                    } else {
                        showError("Gửi mã OTP thất bại!");
                    }
                }
            });
        } else {
            showError("Gửi mã OTP thất bại!");
        }
    }


</script>

</html>